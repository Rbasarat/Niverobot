stages:
  - build
  - infrastructure
  - deploy

build-python:
  image: python:3.8
  stage: build
  before_script:
    - cd Niverobot/Niverobot.Dateparser
  script:
    - python -m pip install -r requirements.txt
    - python -m grpc_tools.protoc -I../Niverobot.Protos --python_out=. --grpc_python_out=. ../Niverobot.Protos/dateparser.proto
    - cp -a . $CI_PROJECT_DIR/artifacts
  artifacts:
    paths:
      - $CI_PROJECT_DIR/artifacts

build-dotnet:
  image: mcr.microsoft.com/dotnet/core/sdk:3.1
  before_script:
    - cd Niverobot
    - dotnet restore
  script:
    - dotnet build --configuration release
    - dotnet publish --configuration release --output $CI_PROJECT_DIR/artifacts/Niverobot.Consumer/ Niverobot.Consumer/Niverobot.Consumer.csproj
    - dotnet publish --configuration release  --output $CI_PROJECT_DIR/artifacts/Niverobot.WebApi/ Niverobot.WebApi/Niverobot.WebApi.csproj
  stage: build
  artifacts:
    paths:
      - artifacts/Niverobot.WebApi/
      - artifacts/Niverobot.Consumer/


pulumi-up:
  stage: infrastructure
  image: mcr.microsoft.com/dotnet/core/sdk:3.1-buster
  script:
    - cd Niverobot/Niverobot.Infrastructure
    - chmod +x ./scripts/*.sh
    - ./scripts/pulumi-up.sh
  artifacts:
    paths:
      - pulumi-log.txt
  only:
    - master

pulumi-preview:
  stage: infrastructure
  image: mcr.microsoft.com/dotnet/core/sdk:3.1-buster
  script:
    - cd Niverobot/Niverobot.Infrastructure
    - chmod +x ./scripts/*.sh
    - ./scripts/pulumi-preview.sh
  only:
    - merge_requests